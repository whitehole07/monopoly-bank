<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monopoly NFC Bank</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body { font-family: system-ui, sans-serif; background:#f0f2f5; margin:0; padding:16px }
    h1 { font-size:1.6rem; margin-bottom:16px; text-align:center; color:#333 }
    .container { max-width:520px; margin:auto }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,.08); margin-bottom:12px; transition: transform .1s, box-shadow .1s }
    .card:active { transform: scale(0.98); box-shadow:0 2px 6px rgba(0,0,0,.12) }
    button { padding:12px; font-size:1rem; border:none; border-radius:8px; margin-top:8px; width:100%; cursor:pointer; transition: background .2s }
    .primary { background:#007aff; color:#fff }
    .primary:hover { background:#005ecb }
    .secondary { background:#34c759; color:#fff }
    .secondary:hover { background:#28a745 }
    .danger { background:#ff3b30; color:#fff }
    .danger:hover { background:#cc2a20 }
    .muted { color:#666; font-size:.9rem; margin-top:4px }
    .list-item { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; cursor:pointer; padding:6px; border-radius:6px; transition: background .2s }
    .list-item:hover { background:#e9ecef }
    input { width:100%; padding:10px; font-size:1rem; margin-top:6px; border:1px solid #ccc; border-radius:6px }
    select { width:100%; padding:10px; font-size:1rem; margin-top:6px; border:1px solid #ccc; border-radius:6px }
    #statusMsg { font-size:.95rem; color:#007aff; margin-top:6px }
  </style>
</head>
<body>
<div class="container">
  <h1>üè¶ Monopoly NFC Bank - Leaderboard</h1>  <!-- Player Leaderboard -->  <div class="card">
    <h3>Leaderboard (by balance)</h3>
    <div id="playerList" class="muted">No players registered</div>
    <button class="primary" onclick="scanForNewPlayer()">Add New Player (Scan Card)</button>
    <div id="statusMsg"></div>
  </div>  <!-- Inspect Player -->  <div id="inspectCard" class="card" style="display:none"></div>
</div><script>
let db;
let scanning = false;
let inspectedUID = null;
const statusMsg = document.getElementById('statusMsg');

const openReq = indexedDB.open('bankDB', 1);
openReq.onupgradeneeded = e => {
  const db = e.target.result;
  db.createObjectStore('players', { keyPath: 'uid' });
};
openReq.onsuccess = e => {
  db = e.target.result;
  refreshPlayerList();
};

async function scanCard(callback) {
  if (!('NDEFReader' in window)) return alert('Web NFC not supported');
  if (scanning) return;
  scanning = true;
  statusMsg.innerText = 'Scanning for NFC card...';
  const reader = new NDEFReader();
  await reader.scan();
  reader.onreading = e => {
    scanning = false;
    statusMsg.innerText = 'Card detected!';
    setTimeout(() => statusMsg.innerText = '', 2000);
    callback(e.serialNumber);
  };
}

function refreshPlayerList() {
  const tx = db.transaction('players', 'readonly');
  const store = tx.objectStore('players');
  const req = store.getAll();
  req.onsuccess = () => {
    const list = document.getElementById('playerList');
    list.innerHTML = '';
    if (req.result.length === 0) {
      list.innerText = 'No players registered';
      return;
    }
    const sorted = req.result.sort((a,b) => b.balance - a.balance);
    sorted.forEach(p => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `<span>${p.name} ‚Äî ${p.balance}</span><button class='danger' onclick='removePlayer("${p.uid}");event.stopPropagation()'>‚úï</button>`;
      div.onclick = () => inspectPlayer(p.uid);
      list.appendChild(div);
    });
  };
}

function removePlayer(uid) {
  if (!confirm('Remove player?')) return;
  const tx = db.transaction('players', 'readwrite');
  tx.objectStore('players').delete(uid);
  tx.oncomplete = () => { refreshPlayerList(); statusMsg.innerText='Player removed'; setTimeout(()=>statusMsg.innerText='',2000); };
}

async function scanForNewPlayer() {
  statusMsg.innerText = 'Press your card to register';
  await scanCard(uid => {
    const tx = db.transaction('players', 'readonly');
    const store = tx.objectStore('players');
    const req = store.get(uid);
    req.onsuccess = () => {
      if (req.result) { alert('Player already registered'); return; }
      const name = prompt('Player name');
      if (!name) return;
      const player = { uid, name, balance: 1500 };
      const wtx = db.transaction('players', 'readwrite');
      wtx.objectStore('players').put(player);
      wtx.oncomplete = () => { refreshPlayerList(); statusMsg.innerText='Player added'; setTimeout(()=>statusMsg.innerText='',2000); };
    };
  });
}

function inspectPlayer(uid) {
  inspectedUID = uid;
  document.getElementById('inspectCard').style.display = 'block';
  document.getElementById('inspectCard').innerHTML = `<p>Press 'Scan Card' to confirm identity</p><button class='primary' onclick='scanForInspect()'>Scan Card</button>`;
}

async function scanForInspect() {
  if (!inspectedUID) return;
  statusMsg.innerText = 'Scan the player card to proceed';
  await scanCard(scannedUID => {
    if (scannedUID !== inspectedUID) { alert('Wrong card scanned'); return; }
    loadInspectPlayer(scannedUID);
    statusMsg.innerText = 'Player verified';
    setTimeout(()=>statusMsg.innerText='',2000);
  });
}

function loadInspectPlayer(uid) {
  const tx = db.transaction('players', 'readonly');
  tx.objectStore('players').get(uid).onsuccess = e => renderInspect(e.target.result);
}

function renderInspect(p) {
  const card = document.getElementById('inspectCard');
  card.innerHTML = `
    <h3>${p.name}</h3>
    <p><strong>Balance:</strong> ${p.balance}</p>
    <input id='amount' type='number' placeholder='Amount' />
    <select id='target'>
      <option value='bank'>Pay Bank</option>
    </select>
    <button class='secondary' onclick='executePayment("${p.uid}")'>Confirm Payment</button>
    <button class='danger' onclick='closeInspect()'>Close</button>
  `;

  const sel = document.getElementById('target');
  const tx2 = db.transaction('players', 'readonly');
  tx2.objectStore('players').getAll().onsuccess = e => {
    e.target.result.filter(x => x.uid !== p.uid).forEach(x => {
      const opt = document.createElement('option');
      opt.value = x.uid;
      opt.text = x.name;
      sel.appendChild(opt);
    });
  };
}

function executePayment(fromUid) {
  const amount = parseInt(document.getElementById('amount').value);
  const target = document.getElementById('target').value;
  if (!amount || amount <= 0) { alert('Invalid amount'); return; }

  const tx = db.transaction('players', 'readwrite');
  const store = tx.objectStore('players');
  store.get(fromUid).onsuccess = e => {
    const from = e.target.result;
    if (from.balance < amount) { alert('Insufficient funds'); return; }
    from.balance -= amount;
    store.put(from);

    if (target !== 'bank') {
      store.get(target).onsuccess = ev => {
        const to = ev.target.result;
        to.balance += amount;
        store.put(to);
      };
    }
    tx.oncomplete = () => {
      refreshPlayerList();
      loadInspectPlayer(fromUid);
      statusMsg.innerText = 'Payment successful';
      setTimeout(()=>statusMsg.innerText='',2000);
    };
  };
}

function closeInspect() {
  inspectedUID = null;
  document.getElementById('inspectCard').style.display = 'none';
  statusMsg.innerText = 'Inspection closed';
  setTimeout(()=>statusMsg.innerText='',2000);
}
</script></body>
</html>
