<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monopoly NFC Bank</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body { font-family: system-ui, sans-serif; background:#f4f6f8; margin:0; padding:16px }
    h1 { font-size:1.5rem; margin-bottom:12px }
    .container { max-width:520px; margin:auto }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 4px 10px rgba(0,0,0,.08); margin-bottom:12px }
    button { padding:10px; font-size:1rem; border:none; border-radius:8px; margin-top:6px; width:100% }
    .primary { background:#007aff; color:#fff }
    .secondary { background:#34c759; color:#fff }
    .danger { background:#ff3b30; color:#fff }
    .muted { color:#666; font-size:.9rem }
    .list-item { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; cursor:pointer }
    input { width:100%; padding:8px; font-size:1rem; margin-top:6px }
    select { width:100%; padding:8px; font-size:1rem; margin-top:6px }
  </style>
</head>
<body>
<div class="container">
  <h1>üè¶ Monopoly NFC Bank - Leaderboard</h1>  <!-- Player Leaderboard -->  <div class="card">
    <h3>Leaderboard (by balance)</h3>
    <div id="playerList" class="muted">No players registered</div>
    <button class="primary" onclick="scanForNewPlayer()">Add New Player (Scan Card)</button>
  </div>  <!-- Inspect Player -->  <div id="inspectCard" class="card" style="display:none"></div>
</div><script>
let db;
let scanning = false;
let inspectedUID = null;

const openReq = indexedDB.open('bankDB', 1);
openReq.onupgradeneeded = e => {
  const db = e.target.result;
  db.createObjectStore('players', { keyPath: 'uid' });
};
openReq.onsuccess = e => {
  db = e.target.result;
  refreshPlayerList();
};

async function scanCard(callback) {
  if (!('NDEFReader' in window)) return alert('Web NFC not supported');
  if (scanning) return;
  scanning = true;
  const reader = new NDEFReader();
  await reader.scan();
  reader.onreading = e => {
    scanning = false;
    callback(e.serialNumber);
  };
}

/* ---------- PLAYER LIST ---------- */
function refreshPlayerList() {
  const tx = db.transaction('players', 'readonly');
  const store = tx.objectStore('players');
  const req = store.getAll();
  req.onsuccess = () => {
    const list = document.getElementById('playerList');
    list.innerHTML = '';
    if (req.result.length === 0) {
      list.innerText = 'No players registered';
      return;
    }
    // sort by balance descending
    const sorted = req.result.sort((a,b) => b.balance - a.balance);
    sorted.forEach(p => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `<span>${p.name} ‚Äî ${p.balance}</span><button class='danger' onclick='removePlayer("${p.uid}");event.stopPropagation()'>‚úï</button>`;
      div.onclick = () => inspectPlayer(p.uid);
      list.appendChild(div);
    });
  };
}

function removePlayer(uid) {
  if (!confirm('Remove player?')) return;
  const tx = db.transaction('players', 'readwrite');
  tx.objectStore('players').delete(uid);
  tx.oncomplete = refreshPlayerList;
}

/* ---------- ADD PLAYER ---------- */
async function scanForNewPlayer() {
  await scanCard(uid => {
    const tx = db.transaction('players', 'readonly');
    const store = tx.objectStore('players');
    const req = store.get(uid);
    req.onsuccess = () => {
      if (req.result) {
        alert('Player already registered');
        return;
      }
      const name = prompt('Player name');
      if (!name) return;
      const player = { uid, name, balance: 1500 };
      const wtx = db.transaction('players', 'readwrite');
      wtx.objectStore('players').put(player);
      wtx.oncomplete = refreshPlayerList;
    };
  });
}

/* ---------- INSPECT / PAY ---------- */
function inspectPlayer(uid) {
  inspectedUID = uid;
  document.getElementById('inspectCard').style.display = 'block';
  document.getElementById('inspectCard').innerHTML = `<p>Press 'Scan Card' to confirm player identity</p><button class='primary' onclick='scanForInspect()'>Scan Card</button>`;
}

async function scanForInspect() {
  if (!inspectedUID) return;
  await scanCard(scannedUID => {
    if (scannedUID !== inspectedUID) {
      alert('Wrong card scanned');
      return;
    }
    loadInspectPlayer(scannedUID);
  });
}

function loadInspectPlayer(uid) {
  const tx = db.transaction('players', 'readonly');
  tx.objectStore('players').get(uid).onsuccess = e => renderInspect(e.target.result);
}

function renderInspect(p) {
  const card = document.getElementById('inspectCard');
  card.innerHTML = `
    <h3>${p.name}</h3>
    <p><strong>Balance:</strong> ${p.balance}</p>
    <input id='amount' type='number' placeholder='Amount' />
    <select id='target'>
      <option value='bank'>Pay Bank</option>
    </select>
    <button class='secondary' onclick='executePayment("${p.uid}")'>Confirm Payment</button>
    <button class='danger' onclick='closeInspect()'>Close</button>
  `;

  const sel = document.getElementById('target');
  const tx2 = db.transaction('players', 'readonly');
  tx2.objectStore('players').getAll().onsuccess = e => {
    e.target.result.filter(x => x.uid !== p.uid).forEach(x => {
      const opt = document.createElement('option');
      opt.value = x.uid;
      opt.text = x.name;
      sel.appendChild(opt);
    });
  };
}

function executePayment(fromUid) {
  const amount = parseInt(document.getElementById('amount').value);
  const target = document.getElementById('target').value;
  if (!amount || amount <= 0) return alert('Invalid amount');

  const tx = db.transaction('players', 'readwrite');
  const store = tx.objectStore('players');
  store.get(fromUid).onsuccess = e => {
    const from = e.target.result;
    if (from.balance < amount) return alert('Insufficient funds');
    from.balance -= amount;
    store.put(from);

    if (target !== 'bank') {
      store.get(target).onsuccess = ev => {
        const to = ev.target.result;
        to.balance += amount;
        store.put(to);
      };
    }
    tx.oncomplete = () => {
      refreshPlayerList();
      loadInspectPlayer(fromUid);
    };
  };
}

function closeInspect() {
  inspectedUID = null;
  document.getElementById('inspectCard').style.display = 'none';
}
</script></body>
</html>
